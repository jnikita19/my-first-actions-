name: Docker CI Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '20 8 * * *'

jobs:
  build-and-scan:
    uses: AmanjotSinghSaini-int/ci-templates/.github/workflows/docker-build.yml@main
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    with:
      image_name: ghcr.io/my-org/my-app:latest
      dockerfile_path: ./Dockerfile
      context: .
      build_args: "--no-cache"

      run_gitleaks: true
      gitleaks_fetch_depth: 1
      continue_on_gitleaks_error: false

      run_owasp: true
      continue_on_owasp_error: false

      run_pytest: true
      continue_on_pytest_error: true

      run_trivy: true
      continue_on_trivy_error: false

      image_size_threshold_mb: 150        
      continue_on_size_check_error: false 

      push_to_ecr: true
      ecr_repository: image-from-github

      run_sonar: true
      sonar_host_url: http://13.232.206.99:9000
      sonar_project_key: sonar-scan
      sonar_project_name: sonar-scan

      run_cd: false

  save-image-url:
    runs-on: ubuntu-latest
    needs: build-and-scan
    steps:
      - name: Save ECR image URL to file
        run: echo "${{ needs.build-and-scan.outputs.ecr_image_url }}" > image-url.txt

      - name: Upload ECR image URL artifact
        uses: actions/upload-artifact@v4
        with:
          name: ecr-image-url
          path: image-url.txt
